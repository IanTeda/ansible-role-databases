# ============================================================================
# Ansible Task File: mongodb-debian.yaml
# ----------------------------------------------------------------------------
# This file is managed by Ansible. Manual changes may be overwritten!
#
# Purpose: Complete automation of MongoDB (custom-compiled) installation,
# configuration, service management, user setup, firewall, and health checks
# for Debian-based systems.
#
# Managed by: roles/databases/tasks/mongodb-debian.yaml
# Project: ansible_playbook
# Maintainer: IanTeda
# ============================================================================

## 00. SET MONGODB ANSIBLE FACTS
# -----------------------------------------------------------------------------

- name: Display MongoDB variables for debugging
  ansible.builtin.debug:
    var: databases_mongodb
  tags: [debug]

- name: Set MongoDB facts for the role
  ansible.builtin.set_fact:
    mongodb_user: "{{ databases_mongodb.user }}"
    mongodb_group: "{{ databases_mongodb.group }}"
    mongodb_systemd_name: "{{ databases_mongodb.systemd_name | default('mongod') }}"
    # Detect architecture for MongoDB download URL
    mongodb_arch: "{{ 'aarch64' if ansible_architecture == 'aarch64' else 'x86_64' }}"
    # Detect platform for MongoDB download URL (ARM64 uses Ubuntu binaries, x86_64 uses Debian)
    mongodb_platform: "{{ 'ubuntu2204' if ansible_architecture == 'aarch64' else 'debian12' }}"
    mongodb_listen_address: "{{ databases_mongodb.listen_address }}"
    mongodb_port: "{{ databases_mongodb.port }}"
    mongodb_release_major_minor: "{{ databases_mongodb.release.split('.')[:2] | join('.') }}"
  tags: [always]

- name: Set MongoDB repository facts for the role
  ansible.builtin.set_fact:
    mongodb_apt_supported: "{{ ansible_architecture == 'x86_64' }}"
    mongodb_apt_keyring: "/etc/apt/keyrings/mongodb-org-{{ mongodb_release_major_minor }}.gpg"
    mongodb_apt_repository: >-
      deb [ arch=amd64 signed-by=/etc/apt/keyrings/mongodb-org-{{ mongodb_release_major_minor }}.gpg ]
      https://repo.mongodb.org/apt/debian bookworm/mongodb-org/{{ mongodb_release_major_minor }} main
  tags: [always]

- name: Validate MongoDB architecture support
  ansible.builtin.assert:
    that:
      - ansible_architecture in ['x86_64', 'aarch64']
    fail_msg: |
      MongoDB role does not support architecture: {{ ansible_architecture }}
      
      Supported architectures:
      - x86_64 (Intel/AMD 64-bit)
      - aarch64 (ARM 64-bit, e.g., Raspberry Pi 4/5, Apple Silicon)
      
      Current architecture: {{ ansible_architecture }}
      Distribution: {{ ansible_distribution }} {{ ansible_distribution_release }}
      
      Please check MongoDB {{ databases_mongodb.release }} release notes for architecture support.
    success_msg: "MongoDB architecture {{ ansible_architecture }} is supported."
  tags: [always]

- name: Set MongoDB directory facts for the role
  ansible.builtin.set_fact:
    mongodb_config_dir: "{{ databases_mongodb.config_dir }}"
    mongodb_data_dir: "{{ databases_mongodb.data_dir }}"
    mongodb_home_dir: "{{ databases_mongodb.home_dir }}"
    mongodb_systemd_dir: "/lib/systemd/system"
  tags: [always]

- name: Set MongoDB file facts for the role
  ansible.builtin.set_fact:
    mongodb_config_file: "{{ mongodb_config_dir }}/{{ databases_mongodb.user }}.conf"
    mongodb_binary_path: "/usr/bin/mongod"
    mongodb_socket_path: "/tmp/mongodb.sock"
    mongodb_systemd_service: "{{ mongodb_systemd_dir }}/{{ mongodb_systemd_name }}.service"
  tags: [always]

- name: Display MongoDB facts for debugging
  ansible.builtin.debug:
    msg:
      - "Fact -> mongodb_user: {{ mongodb_user }}"
      - "Fact -> mongodb_group: {{ mongodb_group }}"
      - "Fact -> mongodb_arch: {{ mongodb_arch }} (detected: {{ ansible_architecture }})"
      - "Fact -> mongodb_platform: {{ mongodb_platform }}"
      - "Fact -> mongodb_home_dir: {{ mongodb_home_dir }}"
      - "Fact -> mongodb_config_dir: {{ mongodb_config_dir }}"
      - "Fact -> mongodb_config_file: {{ mongodb_config_file }}"
      - "Fact -> mongodb_data_dir: {{ mongodb_data_dir }}"
      - "Fact -> mongodb_systemd_name: {{ mongodb_systemd_name }}"
      - "Fact -> mongodb_download_url: {{ mongodb_download_url }}"
      - "Fact -> mongodb_binary_path: {{ mongodb_binary_path }}"
      - "Fact -> mongodb_socket_path: {{ mongodb_socket_path }}"
  tags: [debug]

#### Remove manual uninstall confirmation. Use dedicated uninstall tag section.

## 01. SHUTDOWN MONGODB SERVICES
# -----------------------------------------------------------------------------
- name: Check if MongoDB service exists
  ansible.builtin.stat:
    path: "{{ mongodb_systemd_service }}"
  register: mongodb_service_file
  tags: [install, config]

- name: Ensure MongoDB service is stopped before modifying
  ansible.builtin.systemd:
    name: "{{ mongodb_systemd_name }}"
    state: stopped
  become: true
  failed_when: false
  when: mongodb_service_file.stat.exists
  tags: [install, config]

- name: Stop and disable MongoDB service for uninstallation
  when: uninstall_confirmation | bool
  ansible.builtin.systemd:
    name: "{{ mongodb_systemd_name }}"
    state: stopped
    enabled: no
  become: true
  failed_when: false
  tags: [uninstall, never]

## 02. SET UP MONGODB USER & CREATE SERVICE DIRECTORIES
# -----------------------------------------------------------------------------
- name: Ensure MongoDB group exists
  ansible.builtin.group:
    name: "{{ mongodb_group }}"
    state: present
  become: true
  tags: [install]

- name: Create MongoDB system user
  ansible.builtin.user:
    name: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    comment: "MongoDB Server System Account"
  become: true
  tags: [install]

- name: Delete MongoDB system user on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.user:
    name: "{{ mongodb_user }}"
    state: absent
    remove: true
    force: true
  become: true
  failed_when: false
  tags: [never, uninstall]

- name: Delete MongoDB system group on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.group:
    name: "{{ mongodb_group }}"
    state: absent
    remove: true
    force: true
  become: true
  failed_when: false
  tags: [never, uninstall]

- name: Create directories for MongoDB service
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ mongodb_config_dir }}", mode: "u=rwx,g=rw,o=" }
    - { path: "{{ mongodb_data_dir }}",   mode: "u=rwx,g=r,o="  }
  become: true
  tags: [install, config]

- name: Remove MongoDB directories on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop:
    - { path: "{{ mongodb_config_dir }}" }
    - { path: "{{ mongodb_data_dir }}" }
  become: true
  tags: [never, uninstall]



## 03. DOWNLOAD, INSTALL & VERIFY MONGODB (PREBUILT BINARY)
# -----------------------------------------------------------------------------
- name: Download MongoDB prebuilt binary {{ databases_mongodb.release }}
  ansible.builtin.get_url:
    url: "{{ mongodb_download_url }}"
    dest: "{{ mongodb_download_archive }}"
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    mode: '0644'
    timeout: 60
  become: true
  retries: 3
  delay: 5
  register: mongodb_download_result
  until: mongodb_download_result is succeeded
  tags: [install, binary]

- name: Ensure MongoDB tmp directory exists before extract
  ansible.builtin.file:
    path: "{{ mongodb_download_tmp_dir }}"
    state: directory
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    mode: '0755'
  become: true
  tags: [install, binary]

- name: Extract MongoDB prebuilt binary to tmp directory
  ansible.builtin.unarchive:
    src: "{{ mongodb_download_archive }}"
    dest: "{{ mongodb_download_tmp_dir }}"
    remote_src: true
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    extra_opts: ["--strip-components=1"]
  become: true
  tags: [install, binary]

- name: Copy MongoDB binaries to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ mongodb_download_tmp_dir }}/bin/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    owner: root
    group: root
    mode: '0755'
    remote_src: true
  become: true
  loop:
    - mongod
    - mongos
  tags: [install, binary]

- name: Verify MongoDB binary is installed and has correct permissions
  ansible.builtin.stat:
    path: "/usr/local/bin/mongod"
  register: mongodb_binary_stat
  become: true
  tags: [install, binary, verify, healthcheck]

- name: Assert MongoDB binary is present, executable, and owned by correct user
  ansible.builtin.assert:
    that:
      - mongodb_binary_stat.stat.exists
      - mongodb_binary_stat.stat.executable
      - mongodb_binary_stat.stat.pw_name == 'root'
      - mongodb_binary_stat.stat.gr_name == 'root'
    fail_msg: "MongoDB binary is missing, not executable, or has incorrect ownership."
    success_msg: "MongoDB binary is present, executable, and has correct ownership."
  become: true
  tags: [install, binary, verify, healthcheck]

- name: Clean up MongoDB tmp directory
  ansible.builtin.file:
    path: "/tmp/mongodb-{{ databases_mongodb.release }}"
    state: absent
  become: true
  tags: [install, binary, cleanup]

- name: Clean up downloaded tarball
  ansible.builtin.file:
    path: "/tmp/mongodb-{{ databases_mongodb.release }}.tgz"
    state: absent
  become: true
  tags: [install, binary, cleanup]


## 04. SETUP CONFIG FILE FOR MONGODB
# -----------------------------------------------------------------------------
- name: Deploy MongoDB configuration file
  ansible.builtin.template:
    src: templates/mongodb.conf.j2
    dest: "{{ mongodb_config_file }}"
    owner: "{{ mongodb_user }}"
    group: "{{ mongodb_group }}"
    mode: '0600'
  become: true
  tags: [install, config]

- name: Check MongoDB binary exists before config validation
  ansible.builtin.stat:
    path: "/usr/local/bin/mongod"
  register: mongodb_binary_check
  become: true
  tags: [install, config]

- name: Fail if MongoDB binary is not installed
  ansible.builtin.fail:
    msg: |
      MongoDB binary not found at /usr/local/bin/mongod.
      
      The MongoDB binary must be installed before configuration validation can occur.
      Please ensure the MongoDB installation tasks have been run successfully.
      
      Expected path: /usr/local/bin/mongod
      Config file: {{ mongodb_config_file }}
  when: not mongodb_binary_check.stat.exists
  tags: [install, config]

- name: Check MongoDB configuration file syntax
  ansible.builtin.command:
    cmd: "/usr/local/bin/mongod --config {{ mongodb_config_file }} --help"
  register: mongodb_config_check
  changed_when: false
  failed_when: mongodb_config_check.rc != 0
  become: true
  # Removed become_user to run as root instead of mongodb user
  # become_user: "{{ mongodb_user }}"
  tags: [install, config]
  when: mongodb_binary_check.stat.exists
  ignore_errors: true

- name: Warn about MongoDB config validation failure
  ansible.builtin.debug:
    msg: |
      ⚠️  WARNING: MongoDB configuration validation failed (exit code: {{ mongodb_config_check.rc }})
      
      This may be due to architecture compatibility issues with the pre-compiled MongoDB binary for {{ ansible_architecture }}.
      The configuration file has been created successfully, but syntax validation could not be performed.
      
      Config file: {{ mongodb_config_file }}
      Binary: {{ mongodb_binary_path }}
      Architecture: {{ ansible_architecture }}
      
      The MongoDB service should still function normally despite this validation failure.
  when: mongodb_config_check.failed | default(false)
  tags: [install, config]

## 05. SETUP SYSTEMD FOR MONGODB
# -----------------------------------------------------------------------------
- name: Deploy systemd unit for MongoDB
  ansible.builtin.template:
    src: templates/mongodb-systemd.service.j2
    dest: "/lib/systemd/system/{{ mongodb_systemd_name }}.service"
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: [install, config]

- name: Verify MongoDB systemd service config is valid
  ansible.builtin.command: "systemd-analyze verify /lib/systemd/system/{{ mongodb_systemd_name }}.service"
  register: mongodb_systemd_verify
  changed_when: false
  failed_when: mongodb_systemd_verify.rc != 0
  tags: [install, config, verify]

- name: Reload systemd and start MongoDB service
  ansible.builtin.systemd_service:
    daemon_reload: true
    name: "{{ mongodb_systemd_name }}"
    enabled: true
    state: started
  become: true
  tags: [install, config]

- name: Verify MongoDB service is active
  ansible.builtin.systemd:
    name: "{{ mongodb_systemd_name }}"
  register: mongodb_service_status
  changed_when: false
  tags: [install, config, verify, healthcheck]

- name: Assert MongoDB service is running
  ansible.builtin.assert:
    that:
      - mongodb_service_status.status.ActiveState == "active"
    fail_msg: |
      MongoDB service failed to start (ActiveState: {{ mongodb_service_status.status.ActiveState }}).
      
      This is likely due to CPU architecture incompatibility. The current CPU architecture ({{ ansible_architecture }})
      may not support the instruction set required by MongoDB {{ databases_mongodb.release }}.
      
      Possible solutions:
      1. Use an older MongoDB version compatible with your CPU architecture
      2. Verify MongoDB {{ databases_mongodb.release }} supports {{ ansible_architecture }} architecture
      3. Check MongoDB release notes for architecture compatibility
      4. Consider alternative database solutions
      
      Service status: {{ mongodb_service_status.status.ExecMainStatus }}
      Exit code: {{ mongodb_service_status.status.ExecMainCode }}
    success_msg: "MongoDB service is active."
  ignore_errors: true
  tags: [install, config, verify, healthcheck]



## 06. SETUP FIREWALL FOR MONGODB
# -----------------------------------------------------------------------------
- name: Deploy MongoDB UFW application profile
  ansible.builtin.template:
    src: templates/mongodb-ufw-profile.j2
    dest: "/etc/ufw/applications.d/{{ mongodb_systemd_name }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: [install, config] 

- name: Reload UFW MongoDB application profiles
  ansible.builtin.command: "ufw app update {{ mongodb_systemd_name }}"
  become: true
  changed_when: false
  failed_when: false
  tags: [install, config]

- name: Allow MongoDB through UFW using application profile
  ansible.builtin.ufw:
    rule: allow
    name: "MongoDB"
    comment: "Allow MongoDB ({{ mongodb_port }}/tcp) from LOCAL NET"
    src: "{{ item }}"
  loop: "{{ networking_networks.local }}"
  become: true
  tags: [never, firewall]

- name: Confirm MongoDB UFW profile is allowed for local networks
  ansible.builtin.command: "ufw status numbered"
  register: mongodb_ufw_status
  changed_when: false
  tags: [never, firewall]

- name: Assert MongoDB UFW rule exists for each local network
  ansible.builtin.assert:
    that:
      - "'MongoDB' in mongodb_ufw_status.stdout and item in mongodb_ufw_status.stdout"
    fail_msg: "MongoDB UFW rule is NOT present for {{ item }}"
    success_msg: "MongoDB UFW rule is present for {{ item }}"
  loop: "{{ networking_networks.local }}"
  tags: [never, firewall]

- name: Remove UFW rules for MongoDB application profile on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.ufw:
    rule: deny
    name: "MongoDB"
    delete: true
  become: true
  failed_when: false
  tags: [never, uninstall]

- name: Remove MongoDB UFW application profile on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.file:
    path: "/etc/ufw/applications.d/{{ mongodb_systemd_name }}"
    state: absent
  become: true
  tags: [never, uninstall]

## 07. HEALTH CHECKS FOR MONGODB
# -----------------------------------------------------------------------------
- name: Wait for MongoDB to be available
  ansible.builtin.wait_for:
    host: "{{ databases_mongodb.listen_address }}"
    port: "{{ databases_mongodb.port }}"
    timeout: 30
  when: mongodb_service_status.status.ActiveState == "active"
  tags: [install, config, verify, healthcheck]

- name: Check MongoDB process is running
  ansible.builtin.shell: "pgrep mongod"
  register: mongod_process_check
  changed_when: false
  failed_when: mongod_process_check.rc != 0
  when: mongodb_service_status.status.ActiveState == "active"
  tags: [install, config, verify, healthcheck]

- name: Check MongoDB responds to ping
  ansible.builtin.command: "/usr/local/bin/mongo --eval 'db.runCommand({ ping: 1 })' --quiet"
  register: mongodb_ping_check
  changed_when: false
  failed_when: "'ok' not in mongodb_ping_check.stdout"
  tags: [install, config, verify, healthcheck]

- name: Check MongoDB version
  ansible.builtin.command: "/usr/local/bin/mongod --version"
  register: mongodb_version_check
  changed_when: false
  tags: [install, config, verify, healthcheck]

- name: Show MongoDB version
  ansible.builtin.debug:
    var: mongodb_version_check.stdout
  tags: [install, config, verify, healthcheck]
