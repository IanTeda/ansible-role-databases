# ============================================================================
# Ansible Task File: mariadb-debian.yaml
# ----------------------------------------------------------------------------
# This file is managed by Ansible. Manual changes may be overwritten!
#
# Purpose: Complete automation of MariaDB (custom-compiled) installation,
# configuration, service management, user setup, firewall, and health checks
# for Debian-based systems.
#
# Managed by: roles/databases/tasks/mariadb-debian.yaml
# Project: ansible_playbook
# Maintainer: Ian Teda
# ============================================================================

# 00. SET MARIADB ANSIBLE FACTS
# This makes it easier to read the ansible tasks
# -----------------------------------------------------------------------------

- name: Set MariaDB facts for the role
  ansible.builtin.set_fact:
    mariadb_user: "{{ databases_mariadb.user }}"
    mariadb_group: "{{ databases_mariadb.group }}"
    mariadb_home_dir: "/opt/{{ databases_mariadb.user }}"
    mariadb_config_dir: "/etc/{{ databases_mariadb.user }}"
    mariadb_config_file: "/etc/{{ databases_mariadb.user }}/{{ databases_mariadb.user }}.conf"
    mariadb_data_dir: "/data/{{ databases_mariadb.user }}"
    mariadb_run_dir: "/run/{{ databases_mariadb.user }}"
    mariadb_systemd_name: "{{ databases_mariadb.user }}"
    mariadb_download_url: "https://archive.mariadb.org/mariadb-{{ databases_mariadb.release }}/source/mariadb-{{ databases_mariadb.release }}.tar.gz"
    mariadb_binary_path: "/usr/local/bin/mariadb"
    mariadb_socket_path: "{{ databases_mariadb.socket_path }}"
  tags: [always]

- name: Display MariaDB variables for debugging
  ansible.builtin.debug:
    var: databases_mariadb
  tags:
    - debug

- name: Display MariaDB facts for debugging
  ansible.builtin.debug:
    msg:
      - "Fact -> mariadb_user: {{ mariadb_user }}"
      - "Fact -> mariadb_group: {{ mariadb_group }}"
      - "Fact -> mariadb_home_dir: {{ mariadb_home_dir }}"
      - "Fact -> mariadb_config_dir: {{ mariadb_config_dir }}"
      - "Fact -> mariadb_config_file: {{ mariadb_config_file }}"
      - "Fact -> mariadb_data_dir: {{ mariadb_data_dir }}"
      - "Fact -> mariadb_systemd_name: {{ mariadb_systemd_name }}"
      - "Fact -> mariadb_download_url: {{ mariadb_download_url }}"
      - "Fact -> mariadb_binary_path: {{ mariadb_binary_path }}"
  tags:
    - debug



# 00b. UNINSTALL CONFIRMATION
# -----------------------------------------------------------------------------

- name: Confirm MariaDB uninstallation
  ansible.builtin.pause:
    prompt: |
      âš ï¸  WARNING: MariaDB Uninstallation Confirmation âš ï¸
      
      You are about to completely uninstall the MariaDB service from this system.
      
      This will remove:
      ðŸ—‘ï¸  Service binary: /usr/local/bin/mysqld
      ðŸ—‘ï¸  Systemd service: {{ mariadb_systemd_name }}.service
      ðŸ—‘ï¸  Configuration files: {{ mariadb_config_dir }}/
      ðŸ—‘ï¸  User account: {{ mariadb_user }}
      ðŸ—‘ï¸  UFW firewall rules: MariaDB profile
      
      Are you sure you want to proceed with the uninstallation? (yes/no)
  register: uninstall_confirmation
  tags:
    - never
    - uninstall

- name: Aborted MariaDB uninstallation 
  ansible.builtin.fail:
    msg: |
      ðŸ›‘ Uninstallation aborted by user choice
      
      The MariaDB service remains installed and operational.
      No changes have been made to the system.
  when: not (uninstall_confirmation.user_input | bool)
  tags:
    - never
    - uninstall



# 01. SETUP MARIADB SERVICES
# This section ensures that the service is stopped before config any changes and 
# updates are applied to prevent conflict issues.
# -----------------------------------------------------------------------------

- name: Check if MariaDB service exists
  ansible.builtin.stat:
    path: "/lib/systemd/system/{{ mariadb_systemd_name }}.service"
  register: mariadb_service_file
  tags:
    - install
    - config

- name: Ensure MariaDB service is stopped before modifying
  ansible.builtin.systemd:
    name: "{{ mariadb_systemd_name }}"
    state: stopped
  become: true
  failed_when: false
  when: mariadb_service_file.stat.exists
  tags:
    - install
    - config

- name: Stop and disable MariaDB service for uninstallation
  when: uninstall_confirmation | bool
  ansible.builtin.systemd:
    name: "{{ mariadb_systemd_name }}"
    state: stopped
    enabled: no
  become: true
  failed_when: false
  tags:
    - uninstall
    - never



# 02. SET UP MARIADB USER & CREATE SERVICE DIRECTORIES
# This section sets up the system user and group to run the service and create 
# all the directories for the service
# -----------------------------------------------------------------------------

- name: Ensure MariaDB group exists
  ansible.builtin.group:
    name: "{{ mariadb_group }}"
    state: present
  become: true
  tags:
    - install

- name: Create MariaDB system user
  ansible.builtin.user:
    name: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    comment: "MariaDB Server System Account"
  become: true
  tags:
    - install

- name: Add default user "{{ vault_default_user_name }}" to MariaDB group "{{ mariadb_group }}"
  ansible.builtin.user:
    name: "{{ vault_default_user_name }}"
    groups: "{{ mariadb_group }}"
    append: yes
  become: true
  tags: [install, user_group]


- name: Delete MariaDB system user on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.user:
    name: "{{ mariadb_user }}"
    state: absent
    remove: true
    force: true
  become: true
  failed_when: false
  tags:
    - uninstall
    - never

- name: Delete MariaDB system group on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.group:
    name: "{{ mariadb_group }}"
    state: absent
    remove: true
    force: true
  become: true
  failed_when: false
  tags:
    - uninstall
    - never

- name: Create directories for MariaDB service
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ mariadb_config_dir }}", mode: "u=rwx,g=rw,o=" }
    - { path: "{{ mariadb_data_dir }}",   mode: "u=rwx,g=r,o="  }
  become: true
  tags:
    - install
    - config

- name: Remove MariaDB directories on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop:
    - { path: "{{ mariadb_config_dir }}" }
    - { path: "{{ mariadb_data_dir }}" }
  become: true
  tags:
    - uninstall



## 03. DOWNLOAD, COMPILE, INSTALL & VERIFY MARIADB
# -----------------------------------------------------------------------------

- name: Install MariaDB build dependencies
  ansible.builtin.apt:
    name:
      - build-essential
      - cmake
      - libncurses5-dev
      - libssl-dev
      - libboost-all-dev
      - libaio-dev
      - libjemalloc-dev
      - bison
      - zlib1g-dev
      - libreadline-dev
      - libcurl4-openssl-dev
      - libarchive-dev
      - pkg-config
      - wget
      - python3-pymysql
      - php-mysql
    state: present
    update_cache: true
  become: true
  tags:
    - install
    - build

- name: Download MariaDB source release {{ databases_mariadb.release }}
  ansible.builtin.get_url:
    url: "{{ mariadb_download_url }}"
    dest: "/tmp/mariadb-{{ databases_mariadb.release }}.tar.gz"
    owner: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    mode: '0644'
    timeout: 60
  become: true
  retries: 3
  delay: 5
  register: mariadb_download_result
  until: mariadb_download_result is succeeded
  tags:
    - install
    - build

- name: Ensure MariaDB tmp directory exists before extract
  ansible.builtin.file:
    path: "/tmp/mariadb-{{ databases_mariadb.release }}"
    state: directory
    owner: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    mode: '0755'
  become: true
  tags:
    - install
    - build

- name: Extract MariaDB to tmp destination directory
  ansible.builtin.unarchive:
    src: "/tmp/mariadb-{{ databases_mariadb.release }}.tar.gz"
    dest: "/tmp/mariadb-{{ databases_mariadb.release }}"
    remote_src: true
    owner: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    extra_opts: ["--strip-components=1"]
  become: true
  tags:
    - install
    - build

- name: Configure MariaDB build
  ansible.builtin.command:
    cmd: >
      cmake . -DCMAKE_INSTALL_PREFIX=/usr/local \
      -DMYSQL_DATADIR={{ mariadb_data_dir }} \
      -DSYSCONFDIR={{ mariadb_config_dir }}
    chdir: "/tmp/mariadb-{{ databases_mariadb.release }}"
  become: true
  become_user: "{{ mariadb_user }}"
  changed_when: true
  tags:
    - install
    - build

- name: Build MariaDB
  ansible.builtin.command:
    cmd: "make -j2"
    chdir: "/tmp/mariadb-{{ databases_mariadb.release }}"
  become: true
  become_user: "{{ mariadb_user }}"
  changed_when: true
  tags:
    - install
    - build

- name: Install MariaDB binary using make
  ansible.builtin.command:
    cmd: "make install"
    chdir: "/tmp/mariadb-{{ databases_mariadb.release }}"
  become: true
  tags:
    - install
    - build

- name: Verify MariaDB binary is installed and has correct permissions
  ansible.builtin.stat:
    path: "/usr/local/bin/mysqld"
  register: mariadb_binary_stat
  become: true
  tags:
    - install
    - build
    - verify
    - healthcheck

- name: Assert MariaDB binary is present, executable, and owned by correct user
  ansible.builtin.assert:
    that:
      - mariadb_binary_stat.stat.exists
      - mariadb_binary_stat.stat.executable
      - mariadb_binary_stat.stat.pw_name == 'root'
      - mariadb_binary_stat.stat.gr_name == 'root'
    fail_msg: "MariaDB binary is missing, not executable, or has incorrect ownership."
    success_msg: "MariaDB binary is present, executable, and has correct ownership."
  become: true
  tags:
    - install
    - build
    - verify
    - healthcheck

- name: Clean up MariaDB source directory
  ansible.builtin.file:
    path: "/tmp/mariadb-{{ databases_mariadb.release }}"
    state: absent
  become: true
  tags:
    - install
    - build
    - cleanup

- name: Clean up downloaded tarball
  ansible.builtin.file:
    path: "/tmp/mariadb.tar.gz"
    state: absent
  become: true
  tags:
    - install
    - build
    - cleanup



# 04. SETUP CONFIG FILE FOR MARIADB
# -----------------------------------------------------------------------------

- name: Deploy MariaDB configuration file
  ansible.builtin.template:
    src: templates/mariadb.conf.j2
    dest: "{{ mariadb_config_file }}"
    owner: "{{ mariadb_user }}"
    group: "{{ mariadb_group }}"
    mode: '0600'
  become: true
  tags:
    - install
    - config

- name: Check MariaDB configuration file syntax
  ansible.builtin.shell: >
    /usr/local/bin/mariadb --defaults-file=/etc/mariadb/mariadb.conf --no-defaults --verbose --help
  register: mariadb_config_check
  changed_when: false
  failed_when: mariadb_config_check.rc != 0
  become: true
  become_user: "{{ mariadb_user }}"
  tags:
    - install
    - config
    - verify

- name: Initialise MariaDB if not already initialised
  ansible.builtin.command:
    cmd: "/usr/local/scripts/mariadb-install-db --user={{ mariadb_user }} --datadir={{ mariadb_data_dir }}"
  args:
    creates: "{{ mariadb_data_dir }}/mysql"
  become: true
  become_user: "{{ mariadb_user }}"
  tags:
    - install
    - config
    - init


## 05. SETUP SYSTEMD FOR MARIADB
# ------------------------------------------------------------------------------

- name: Deploy systemd unit for MariaDB
  ansible.builtin.template:
    src: templates/mariadb-systemd.service.j2
    dest: "/lib/systemd/system/{{ mariadb_systemd_name }}.service"
    owner: root
    group: root
    mode: '0644'
  become: true
  tags:
    - install
    - config

- name: Verify MariaDB systemd service config is valid
  ansible.builtin.command: "systemd-analyze verify /lib/systemd/system/{{ mariadb_systemd_name }}.service"
  register: mariadb_systemd_verify
  changed_when: false
  failed_when: mariadb_systemd_verify.rc != 0
  tags:
    - install
    - config
    - verify

- name: Reload systemd and start MariaDB service
  ansible.builtin.systemd_service:
    daemon_reload: true
    name: "{{ mariadb_systemd_name }}"
    enabled: true
    state: started
  become: true
  tags:
    - install
    - config

- name: Verify MariaDB service is active
  ansible.builtin.systemd:
    name: "{{ mariadb_systemd_name }}"
  register: mariadb_service_status
  changed_when: false
  tags:
    - verify
    - healthcheck

- name: Assert mariadb service is running
  ansible.builtin.assert:
    that:
      - mariadb_service_status.status.ActiveState == "active"
    fail_msg: "MariaDB service is NOT active."
    success_msg: "MariaDB service is active."
  tags:
    - verify
    - healthcheck

- name: Wait for MariaDB socket to be available
  ansible.builtin.wait_for:
    path: "{{ mariadb_socket_path }}"
    state: present
    timeout: 15
  become: true
  tags:
    - install
    - config
    - verify

- name: Create custom MariaDB admin user
  community.mysql.mysql_user:
    name: "{{ databases_admin.user }}"
    password: "{{ databases_admin.password }}"
    host: "{{ item }}"
    priv: "*.*:ALL,GRANT"
    login_unix_socket: "{{ mariadb_socket_path }}"
    state: present
    column_case_sensitive: false
  loop:
    - 'localhost'
    - '127.0.0.1'
  become: true
  tags:
    - install
    - config
    - verify

- name: Verify custom MariaDB admin user can connect and has privileges
  community.mysql.mysql_info:
    login_user: "{{ databases_admin.user }}"
    login_password: "{{ databases_admin.password }}"
    login_unix_socket: "{{ mariadb_socket_path }}"
    filter: users
  register: mariadb_admin_info
  tags:
    - install
    - config
    - verify

- name: Show all MariaDB users found
  ansible.builtin.debug:
    var: mariadb_admin_info.users
  tags:
    - debug

- name: Assert custom MariaDB admin user exists
  ansible.builtin.assert:
    that:
      - "(mariadb_admin_info.users.get('localhost', {}) | dict2items | selectattr('key', 'equalto', databases_admin.user) | list | length > 0) or
         (mariadb_admin_info.users.get('127.0.0.1', {}) | dict2items | selectattr('key', 'equalto', databases_admin.user) | list | length > 0)"
    fail_msg: "Custom MariaDB admin user cannot connect or does not exist."
    success_msg: "Custom MariaDB admin user exists and can connect."
  tags:
    - install
    - config
    - verify



## 06. SETUP FIREWALL FOR MARIADB
# -----------------------------------------------------------------------------

- name: Deploy MariaDB UFW application profile
  ansible.builtin.template:
    src: templates/mariadb-ufw-profile.j2
    dest: "/etc/ufw/applications.d/{{ mariadb_systemd_name }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  tags:
    - install
    - config

- name: Reload UFW MariaDB application profiles
  ansible.builtin.command: "ufw app update {{ mariadb_systemd_name }}"
  become: true
  changed_when: false
  failed_when: false
  tags:
    - install
    - config

- name: Allow MariaDB through UFW using application profile
  ansible.builtin.ufw:
    rule: allow
    name: "MariaDB"
    comment: "Allow MariaDB ({{ databases_mariadb.port }}/tcp) from LOCAL NET"
    src: "{{ item }}"
  loop: "{{ networking_networks.local }}"
  become: true
  tags:
    - never
    - firewall

- name: Confirm MariaDB UFW profile is allowed for local networks
  ansible.builtin.command: "ufw status numbered"
  register: mariadb_ufw_status
  changed_when: false
  tags:
    - never
    - firewall

- name: Assert MariaDB UFW rule exists for each local network
  ansible.builtin.assert:
    that:
      - "'MariaDB' in mariadb_ufw_status.stdout and item in mariadb_ufw_status.stdout"
    fail_msg: "MariaDB UFW rule is NOT present for {{ item }}"
    success_msg: "MariaDB UFW rule is present for {{ item }}"
  loop: "{{ networking_networks.local }}"
  tags:
    - never
    - firewall

- name: Remove UFW rules for MariaDB application profile on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.ufw:
    rule: deny
    name: "MariaDB"
    delete: true
  become: true
  failed_when: false
  tags:
    - uninstall
    - never

- name: Remove MariaDB UFW application profile on uninstall
  when: uninstall_confirmation | bool
  ansible.builtin.file:
    path: "/etc/ufw/applications.d/{{ mariadb_systemd_name }}"
    state: absent
  become: true
  tags:
    - uninstall
    - never



## 07. HEALTH CHECKS FOR MARIADB
# ------------------------------------------------------------------------------

- name: Wait for MariaDB to be available
  ansible.builtin.wait_for:
    port: "{{ databases_mariadb.port }}"
    host: "{{ databases_mariadb.listen_address }}"
    timeout: 30
  tags:
    - install
    - config
    - verify
    - healthcheck

